name: Codemagic AutoBuild (final)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify-codemagic-token:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Codemagic Token
        env:
          CM_TOKEN: ${{ secrets.CODEMAGIC_API_TOKEN }}
          CM_TEAM:  ${{ secrets.CODEMAGIC_TEAM_ID }}
        run: |
          echo "üîç Checking token access..."
          curl -sSf https://api.codemagic.io/me \
            -H "x-auth-token: $CM_TOKEN" \
            -H "x-team-id: $CM_TEAM" | jq .

  build-smart-assistant:
    needs: verify-codemagic-token
    runs-on: ubuntu-latest
    steps:
      - name: Trigger build for Smart Assistant
        env:
          CM_TOKEN: ${{ secrets.CODEMAGIC_API_TOKEN }}
          CM_TEAM:  ${{ secrets.CODEMAGIC_TEAM_ID }}
          APP_ID:   ${{ secrets.CODEMAGIC_APP_ID }}
          WF_ID:    ${{ secrets.CODEMAGIC_WORKFLOW_ID_SMART_ASSISTANT }}
        run: |
          echo "üöÄ Starting smart-assistant build..."
          curl -sSf -X POST https://api.codemagic.io/builds \
            -H "Content-Type: application/json" \
            -H "x-auth-token: $CM_TOKEN" \
            -H "x-team-id: $CM_TEAM" \
            -d "{\"appId\": \"$APP_ID\", \"workflowId\": \"$WF_ID\", \"branch\": \"main\"}"

  build-control-panel:
    needs: verify-codemagic-token
    runs-on: ubuntu-latest
    steps:
      - name: Trigger build for Control Panel
        env:
          CM_TOKEN: ${{ secrets.CODEMAGIC_API_TOKEN }}
          CM_TEAM:  ${{ secrets.CODEMAGIC_TEAM_ID }}
          APP_ID:   ${{ secrets.CODEMAGIC_CONTROL_PANEL_ID }}
          WF_ID:    ${{ secrets.CODEMAGIC_WORKFLOW_ID_CONTROL_PANEL }}
        run: |
          echo "üöÄ Starting control-panel build..."
          curl -sSf -X POST https://api.codemagic.io/builds \
            -H "Content-Type: application/json" \
            -H "x-auth-token: $CM_TOKEN" \
            -H "x-team-id: $CM_TEAM" \
            -d "{\"appId\": \"$APP_ID\", \"workflowId\": \"$WF_ID\", \"branch\": \"main\"}"
