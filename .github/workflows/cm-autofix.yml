name: Codemagic AutoFix (L1-L4)

on:
  workflow_dispatch:
    inputs:
      app:
        description: 'smart or control'
        required: true
        default: 'smart'
      level:
        description: 'AutoFix Level (L1,L2,L3,L4)'
        required: true
        default: 'L4'

jobs:
  autofix:
    runs-on: ubuntu-latest
    env:
      ORG: ibrahimalsattouf88-lab
    steps:
      - uses: actions/checkout@v4

      - name: Vars
        id: v
        run: |
          if [ "${{ github.event.inputs.app }}" = "smart" ]; then
            echo "repo=smart-assistant-app" >> $GITHUB_OUTPUT
            echo "pkg=com.example.smartassistant" >> $GITHUB_OUTPUT
            echo "wf=${{ secrets.CODEMAGIC_WORKFLOW_ID_SMART_ASSISTANT }}" >> $GITHUB_OUTPUT
          else
            echo "repo=control-panel-app" >> $GITHUB_OUTPUT
            echo "pkg=com.example.controlpanel" >> $GITHUB_OUTPUT
            echo "wf=${{ secrets.CODEMAGIC_WORKFLOW_ID_CONTROL_PANEL }}" >> $GITHUB_OUTPUT
          fi

      - name: Pick token
        id: t
        run: |
          if [ -n "${{ secrets.GIT_PUSH_TOKEN }}" ]; then
            echo "token=${{ secrets.GIT_PUSH_TOKEN }}" >> $GITHUB_OUTPUT
          else
            echo "token=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
          fi

      - name: Clone target (write)
        run: |
          git clone "https://x-access-token:${{ steps.t.outputs.token }}@github.com/${{ env.ORG }}/${{ steps.v.outputs.repo }}.git" target
          cd target
          git config user.name "autopilot"
          git config user.email "autopilot@${{ env.ORG }}"

      - name: L1 clean (optional)
        if: ${{ contains('L1,L2,L3,L4', github.event.inputs.level) }}
        run: |
          cd target
          (flutter --version >/dev/null 2>&1 && flutter clean) || true

      - name: L2 Gradle sanity (optional)
        if: ${{ contains('L2,L3,L4', github.event.inputs.level) }}
        run: |
          cd target
          sed -i 's/compileSdk [0-9][0-9]*/compileSdk 34/g' android/app/build.gradle || true
          sed -i 's/minSdk [0-9][0-9]*/minSdk 24/g' android/app/build.gradle || true
          if [ -f android/app/build.gradle ] && ! grep -q 'androidx.multidex:multidex' android/app/build.gradle 2>/dev/null; then
            awk '/dependencies *\{/{print;print "    implementation \"androidx.multidex:multidex:2.0.1\"";next}1' android/app/build.gradle > __g && mv __g android/app/build.gradle
          fi
          # ملفات أساسية لو ناقصة
          mkdir -p android/gradle/wrapper
          [ -f android/gradle/wrapper/gradle-wrapper.properties ] || cat > android/gradle/wrapper/gradle-wrapper.properties <<'P'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.7-all.zip
P
          [ -f android/gradle.properties ] || cat > android/gradle.properties <<'P'
org.gradle.jvmargs=-Xmx4G
android.useAndroidX=true
android.enableJetifier=true
P

      - name: L3 Embedding v2 (optional)
        if: ${{ contains('L3,L4', github.event.inputs.level) }}
        run: |
          cd target
          PKG="${{ steps.v.outputs.pkg }}"
          JAVA_DIR="android/app/src/main/java/$(echo "$PKG" | tr '.' '/')"
          mkdir -p "$JAVA_DIR"
          printf "package %s;\n\nimport io.flutter.embedding.android.FlutterActivity;\n\npublic class MainActivity extends FlutterActivity { }\n" "$PKG" > "$JAVA_DIR/MainActivity.java"
          M="android/app/src/main/AndroidManifest.xml"
          if [ -f "$M" ] && ! grep -q 'flutterEmbedding' "$M"; then
            awk 'BEGIN{done=0} /<application/{print; if(!done){print "        <meta-data android:name=\"flutterEmbedding\" android:value=\"2\" />"; done=1; next} } {print}' "$M" > __m && mv __m "$M"
          fi

      - name: L4 Fix Codemagic prebuild (auto-repair Android dir)
        if: ${{ contains('L4', github.event.inputs.level) }}
        run: |
          cd target
          # أضف خطوة إصلاح قبل البناء في codemagic.yaml
          CM="codemagic.yaml"
          if [ -f "$CM" ] && ! grep -q 'Repair Android project' "$CM"; then
            awk '
              /scripts:/ && !added { 
                print; 
                print "      - name: Repair Android project";
                print "        script: |";
                print "          if [ ! -f android/settings.gradle ] || [ ! -f android/app/build.gradle ]; then";
                print "            flutter create .";
                print "          fi";
                added=1; next 
              }1
            ' "$CM" > __cm && mv __cm "$CM"
          fi
          # إنشاء ملفات دنيا إن كانت مفقودة لتسمح للـflutter create يكمل على Codemagic
          [ -f android/settings.gradle ] || echo "include ':app'" > android/settings.gradle
          mkdir -p android/app/src/main

      - name: Commit & push
        run: |
          cd target
          git add -A
          if git diff --cached --quiet; then
            echo "no changes"
          else
            git commit -m "AutoFix ${ { github.event.inputs.level } }: Android structure & Codemagic prebuild repair"
            git push origin main
          fi

      - name: Trigger Codemagic
        run: |
          curl -sS -X POST https://api.codemagic.io/builds \
            -H "x-auth-token: ${{ secrets.CODEMAGIC_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{ \"appId\": \"${{ secrets.CODEMAGIC_APP_ID }}\", \"workflowId\": \"${{ steps.v.outputs.wf }}\", \"branch\": \"main\" }"
